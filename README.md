# Marble Machine

NB: best run on Chrome with headphones connected via 3.5mm. Otherwise, check out the video demo.

[Live Site](https://hanhee-song.github.io/marble_machine/)

[Sample Song 1](https://hanhee-song.github.io/marble_machine/#/eyJ0ZW1wbyI6MTIzLCJtbSI6OTYsImluc3RydW1lbnRzIjp7IlZpYnJhcGhvbmUiOiJ7XCJtdXRlZFwiOltdLFwiYmVhdHNBcnJhecQSW1wiMmdcIixcIjNnXCJdLFvGA8YWxgliyR8sXCIxzyZixyYxZcwmNMdTZM0txCTJXCxcIjDGENFyMWPON2PJW8xrMmZzxQgxYdFlxB7IbDFkzS4zyAjvAJvGJspkyCdhxQcwxA/ML8cQ6gE95gEI+QE9xgf/AT3HJugBPe4BHv8BPf8BPecAoMpr5gDY7wCRyB3JTOcBFsYt/wE7yWLIJ8Z68AGf8QE6zk7wATrkAKLEB+8BYP4Cd/8BOsY08AGNyXnuALHED8pUXCIy5wFR5gD25wFf7wDlyCTmAYvtASP+AUj0AnzEXPkCg119IiwiRHJ1bXP/A+rlA+praWNryEVcImhhdMoNc25hcukBN80cyBPJPcoe3Dffbt9uzz3KMMx9ySTOId940EjQDf8A7dda03Us+gDG1XTzANncN/8A9d9A33fdN8gqLNxN3z/tAV7xASr/AOTMIcYVLMoqXX0ifX0=)

[Sample Song 2](https://hanhee-song.github.io/marble_machine/#/eyJ0ZW1wbyI6MTMxLCJtbSI6MTI4LCJpbnN0cnVtZW50cyI6eyJWaWJyYXBob25lIjoie1wibXV0ZWRcIjpbXSxcImJlYXRzQXJyYXnEEltcIjJnXCIsXCIxxwdiXCJdLFvGA1wiMmLFFsQkxRAzxgnGHMoyx0DJGmZzxhRkxgfHDzDECMw+zFPYJ2XGQ2XKEzFjxRMyxgfKGskdzFfMMsxF/ACjxBBh/wCqzD0yYdE0xCvqATjJR/oBaMcwxhbuAL7LTP8Bb+YAj+sBQMxM1CDmAWDzASfnAWDLRsgd9AIK5wCi/wFn6AFn9ACb6ADdZM5VyX3mAJMwxgfnAQPqAV3FJMgdxwf0AKjOI8pA6wCo+QFL/wII/wK57QK57gC47gE29QK5zRPGbOgAsc100ET+A4LzAqTkAsPuAcnNIe4BB8gt9gDi7QMRz2Ay5wCW6QJiyjrHGstUxxPtAKfuAKDJLfICO8gS6QPY7gEQM/ID58YM5wCo8AH/6wGMXX0iLCJEcnVtc/8FZeUFZWtpY2vKS84Oc25hcusA8GhhdNgqzRvfN99v3zjPGMgN3z7fdt84/wDl3zfzALvPP9xe30DKISzfQ9Ii31n/ANjYbtg32X7fQN933zfMd8wvzBbJYNZQLP8B0f8CjP8Cyt0+/wCm9wDm02LfP/cAgV19In19)

Sample Song [A](https://hanhee-song.github.io/marble_machine/#/eyJ0ZW1wbyI6MTIzLCJtbcQJOCwiaW5zdHJ1bWVudHMiOnsiVmlicmFwaG9uZSI6IntcIm11dGVkXCI6W10sXCJiZWF0c0FycmF5xBJbXCIzZ1wiLFwiMmdcIl0sW10sxBNiywxk0h9hygwxZnPKDTLMDc0azDPHcTFl13Fj0h9ky1fJDNISziozZcZJY8sT7ACUNOcAiMwgzGnrAJTEK9QY7QC4YcZP7ADqzB/mAUjNH8sMzBjsANHEGOQBf883xErtAWBixhTwAczvAVXEGccn9QDzxFMsXCIwzFvtAPzUIfQBdMYHMOwBxNBU1yfLTeQBCOQAtfUB8s0ZXCI07AGu5wEh5wD06wHg7QDM0h/kAL7JH+YBUjL7AgbPH/cCDfABvssmyx8s8gMkySbyA6HsAoTHH+0CNegBbF19IiwiRHJ1bXP/BAo6W+oBYN8D3wPfA98D3wPfA98D3wPfA98D3wPfA+QBqn19) [B](https://hanhee-song.github.io/marble_machine/#/eyJ0ZW1wbyI6MTIzLCJtbcQJOCwiaW5zdHJ1bWVudHMiOnsiVmlicmFwaG9uZSI6IntcIm11dGVkXCI6W10sXCJiZWF0c0FycmF5xBJbXCIzZ1wiLFwiMmdcIl0sW10sxBNixhNiyxNkySYsXCIxZMsaYdEtMWZzyg0yxA3EIWHPIddIyyfnAJsxZfIAm+wArmPSJuoArslzy2vtAKDEGcQ/8gDtzSczZcYUY8sT6ADGy3o05wCzzCfHTssmzG3IMuwAoMsf5wDx8wEqMewBKscm03fMJsc5yybEH8cT8ADyzHPHJ+0Bncc6zDPoAIfyAlPtAkzGbegCTMsm6AC0zHrnAWUwzGjnATT0AlPNKNNQ6AHIxgcw7AI1x0LsALfHadQu8gI35wJKMv8CaswgNOcBMctGNO0BkjLrAazrAI3JU9Im6ADh7AL88gPQ9wJ2zybrAdDzAn3wAhHyAoTLJizGO+8D2+0BrvMCN+0BX/MAs8g/XX0iLCJEcnVtc/8E8zpbxDrfA98D3wPfA98D3wPfA98D3wPfA98D3wPHA119In19) [C](https://hanhee-song.github.io/marble_machine/#/eyJ0ZW1wbyI6MTIzLCJtbcQJOCwiaW5zdHJ1bWVudHMiOnsiVmlicmFwaG9uZSI6IntcIm11dGVkXCI6W10sXCJiZWF0c0FycmF5xBJbXCIzZ1wiLFwiMmdcIl0sW10sxBNixhNiyxNkySYsXCIxxg40zCFh0TQxZnPKDTLEDcQhYc8hy0/GQzPMN8hXyzbnALExZfIAsewAxGPJJsRbzBrqAMvIE+QAgfUAtucAmjHGYOQA8NZNzTUzxnQxY8sT6ADq6wC1xEfHJ8RVzC7HVcst5ACC0DnsALX6AKHGE8wt5wFUMewBVMcm8wCFxi3kAZzQQMstxybnAMzxAUPPJ+QBzuQB6cZi9AHwzULoAJ3qAqnvAOTtAqnmAIPHJsc07QKpxnbxAfMsXCIwzHbnAWb0ArDFKPcBtMtX6AIIxgcw7AKwx0HsAoTHcMsu9wC5yxPnAp8y/wK/zCDnAiPMRucDeOcBvTLrANXrAJTJU8om5wEC8AJx5wD2yxPnAp7sAaf6AsTEJvAA+uoCAfMCxPAEH/ICy8sm5AJw6gLS8QJ+5gCW7QII+gJ37QGK7QUZ6AHg7AM26QGZXX0iLCJEcnVtc/8FnzpbxDrfA98D3wPfA98D3wPfA98D3wPfA98D3wPHA119In19)

## About Marble Machine

The core mechanics of this client-side JavaScript app was built in 24 hours using JavaScript and React. The React component rendering process is tightly controlled and 100% optimized for minimal rerendering and reconciliation.

Marble Machine has been inspired by [Wintergatan](https://www.youtube.com/watch?v=IvUU8joBb1Q). As a musician myself (violin, piano, orchestra conducting, guitar, and bass) with prior experience in creating looped electronic/acoustic music, I set out to combine my passion for programming and my love for music in one app.

#### Known Compatibility Issues

* Does not work in Firefox due to the way Firefox handles (or rather, is unable to handle) a large number of concurrent audio files
* Does not work with most Bluetooth audio devices for the same reason given above


## Instrument API
The ```Instrument``` class has the following methods:

#### ```constructor(mm)```

Initialize the instrument by passing in a number of measures. This can be changed later.

#### ```setMm(mm)```

Changes the instrument's mm.

#### ```getName()```

Returns the instrument's name.

### Render methods

#### ```allNotes()```

Returns an array of all of its tones

#### ```getNotes(beat)```

Returns all of the notes that it will play at a given beat

#### ```getLine(note)```

Returns an array of booleans of length mm representing the presence of the given note. This is for the React line component.

#### ```setUpdateComponentCallback(callback, note)```

The Instrument will remember the given callback for the specific note. This is to allow components to force a rerender of the component that stores the instrument's notes in its state.

Example:

```JavaScript
updateNotes() {
  this.setState({
    muted: this.props.instrument.isMuted(this.props.note),
    line: this.props.instrument.getLine(this.props.note),
  });
}

this.props.instrument.setUpdateComponentCallback(this.updateNotes, this.props.note);
```

#### ```updateComponents([note])```

The instrument will invoke all of its callbacks. If a note is passed in, the Instrument will invoke all the callbacks for the given note.

Example

```JavaScript
handleAddNote() {
  this.props.instrument.addNote();
  this.props.instrument.updateComponents(this.props.note)
}
```

### Interface methods

#### ```addNote(note, beat)```

Adds the note to the given beat.

#### ```removeNote(note, beat)```

Removes the note from the given beat.

#### ```playNote(note)```

Plays the note. This method is only for when the user is clicking on the GUI and expects audio feedback after placing a note.

#### ```playAtBeat(beat)```

Plays all the notes at the given beat.

#### ```clearAllNotes()```

Wipes the board clean.

### History

#### ```getMostRecentHistory()```

Returns the timestamp of the most recent change.

#### ```historyPop()```

Undo the most recent change to the given instrument

Example of history handling:

```JavaScript
handleUndo(e) {
  // Hash of { timestamps: [inst, inst] }
  const instrumentUndos = {};
  
  // I use an array because a simultaneous change (namely, hitting
  // that undo button) may result in the same timestamp for multiple instruments
  this.state.instruments.forEach((instrument) => {
    const mostRecent = instrument.getMostRecentHistory();
    if (mostRecent) {
      if (instrumentUndos[mostRecent]) {
        instrumentUndos[mostRecent].push(instrument);
      } else {
        instrumentUndos[mostRecent] = [instrument];
      }
    }
  });
  
  // We're going to put in here the most recent timestamp's instruments
  // plus we'll check the other timestamps to see if they're within
  // about 10 miliseconds
  let instrumentsToReverse = [];
  
  // Get the most recent timestamp
  const keys = Object.keys(instrumentUndos).map(time => Number(time));
  const max = Math.max.apply(null, keys);
  // instrumentsToReverse = instrumentsToReverse.concat(instrumentUndos[max]);
  
  // Iterate over all keys, put anything within 10 miliseconds in the arr
  keys.forEach(timestamp => {
    if (max - timestamp < 10) {
      let instruments = instrumentUndos[timestamp];
      instrumentsToReverse = instrumentsToReverse.concat(instruments);
    }
  });
  
  instrumentsToReverse = [...new Set(instrumentsToReverse)];
  
  if (instrumentsToReverse.length > 0) {
    instrumentsToReverse.forEach(instrument => {
      instrument.historyPop();
      instrument.updateComponents();
    });
  }
}
```

### Mute

#### ```mute([note])```

Mutes all notes. If a note is given, mutes only the given note.

#### ```unmute([note])```

Unmutes all notes. If a note is given, unmutes only the given note.


#### ```isMuted([note])```

Returns a boolean - true if all notes are muted and false if there is at least one unmuted note. If a note is given, returns a boolean for whether or not the given note is muted.

### Import/Export

#### ```exportJSON()```

Exports its internal states as a stringified JSON.

#### ```importJSON(json)```

Takes in either a JSON or a stringified JSON and updates itself to the new data. Will break horribly if an invalid JSON is given.

## Setting up a subclass of the instrument

Here is an example of setting up a subclass. Each instrument must have its own setup method in which it sets its ```this.notes``` array and builds up the ```this.sounds``` hash with audio elements. In the constructor, ```this.name``` must be set. Preloading the audio is optional.

```JavaScript
import Instrument from './instrument';

class Vibraphone extends Instrument {
  constructor(props) {
    super(props);
    // this.notes
    this.setup();
    this.name = "Vibraphone";
    this._preloadAudio();
  }
  
  setup() {
    this.notes = [
      "0e", "0fs",
      "1g", "1a", "1b", "1c", "1d", "1e", "1fs",
      "2g", "2a", "2b", "2c", "2d", "2e", "2fs",
      "3g", "3a", "3b", "3c", "3d", "3e", "3fs",
      "4g", "4a", "4b", "4c"
    ].reverse();
    this.notes.forEach((note) => {
      this.sounds[note] = new Audio(`audio/vib_${note}.wav`);
      this.sounds[note].url = `public/audio/vib_${note}.wav`;
      this.sounds[note].volume = 0.16;
    });
  }
}

export default Vibraphone;
```
